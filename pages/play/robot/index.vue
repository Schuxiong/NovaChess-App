<template>
  <view class="robot-container">
    <!-- È°∂ÈÉ®Èó¥Ë∑ù -->
    <top-spacing :height="statusBarHeight"></top-spacing>
    
    <!-- ‰∏ªÂÜÖÂÆπÂå∫ÂüüÔºàËÆæÁΩÆ‰∏§‰æßÈó¥Ë∑ùÔºâ -->
    <view class="main-content">
      <!-- Ê£ãÁõòÂØπÊàòÂå∫ -->
      <view class="chess-section">
        <!-- ÂØπÊàò‰ø°ÊÅØÂå∫ -->
        <view class="player-info-container">
          <!-- ÂØπÊâã‰ø°ÊÅØÔºàÊú∫Âô®‰∫∫ÊîæÂú®‰∏äÊñπÔºâ -->
          <player-info 
            :is-opponent="true"
            :player-name="robotName"
            :avatar="robotAvatar"
            :flag="robotFlag"
            :is-turn="isRobotTurn"
          />
          
          <!-- Ê£ãÁõòÂå∫Âüü -->
          <view class="board-container">
            <chess-board 
              ref="chessBoard"
              :board-state="boardState"
              :selected-position="selectedPosition"
              :valid-moves="validMoves"
              :last-move="lastMove"
              :current-player="currentPlayer"
              :play-as="playerColor"
              :is-checkmated="isCheckmated"
              :checkmate-color="checkmateColor"
              @cell-click="handleCellClick"
            />
          </view>
          
          <!-- Áé©ÂÆ∂‰ø°ÊÅØÔºàÊîæÂú®Â∫ïÈÉ®Ôºâ -->
          <player-info 
            :is-opponent="false"
            :player-name="playerName"
            :avatar="playerAvatar"
            :flag="playerFlag"
            :is-turn="!isRobotTurn"
          />
        </view>
      </view>
      
      <!-- Êô∫ËÉΩÊïôÁªÉÈÄâÊã©Âå∫ -->
      <view v-if="isSelectionMode" class="coach-section">
        <!-- Ê†áÈ¢òÂå∫ -->
        <view class="coach-title">
          <image class="coach-icon" src="https://pic1.imgdb.cn/item/67f3c4fae381c3632bee8f9d.png" mode="aspectFit"></image>
          <text class="coach-heading">Êô∫ËÉΩÊïôÁªÉ</text>
        </view>
        
        <!-- Êú∫Âô®‰∫∫‰ªãÁªçÂå∫ -->
        <view class="robot-intro">
          <!-- Â∑¶‰æßÂ§¥ÂÉè -->
          <image class="robot-avatar" :src="robotAvatar" mode="aspectFill"></image>
          
          <!-- Âè≥‰æßÊ∞îÊ≥°Ê°ÜÂèä‰ø°ÊÅØ -->
          <view class="robot-details">
            <!-- Ê∞îÊ≥°Ê°ÜËá™Êàë‰ªãÁªç -->
            <view class="speech-bubble">
              <text>ËøôÊòØ‰∏Ä‰∫õÊú∫Âô®‰∫∫È£éÊ†ºËá™Êàë‰ªãÁªç</text>
            </view>
            
            <!-- Â∫ïÈÉ®‰ø°ÊÅØÂå∫Âüü -->
            <view class="robot-info">
              <!-- ÂêçÁß∞ -->
              <text class="robot-name">{{ robotName }}</text>
              <!-- ÁßØÂàÜ -->
              <text class="robot-rating">{{ robotRating }}</text>
              <!-- ÂõΩÊóó -->
              <image v-if="robotFlag" class="robot-flag" :src="robotFlag" mode="aspectFit"></image>
            </view>
          </view>
        </view>
        
        <!-- ÂÄôÈÄâÂàóË°®Âå∫ -->
        <view class="robot-candidates">
          <!-- Á§æÂå∫Ë∑Ø‰∫∫ÂàÜÁªÑ -->
          <view class="candidate-group">
            <text class="group-title">Á§æÂå∫Ë∑Ø‰∫∫</text>
            <view class="candidate-count">5 ‰ΩçÂÄôÈÄâ</view>
            <scroll-view class="candidate-scroll" scroll-x="true">
              <view class="candidate-list">
                <view 
                  v-for="(robot, index) in casualRobots" 
                  :key="index" 
                  class="candidate-item"
                  :class="{ 'selected': selectedRobotId === robot.id }"
                  @click="selectRobot(robot.id)"
                >
                  <image class="candidate-avatar" :src="robot.avatar" mode="aspectFill"></image>
                  <image v-if="robot.locked" class="lock-icon" src="/static/images/robot/lock.png" mode="aspectFit"></image>
                </view>
              </view>
            </scroll-view>
          </view>
          
          <!-- ÊØîËµõÂ∏∏ÂÆ¢ÂàÜÁªÑ -->
          <view class="candidate-group">
            <text class="group-title">ÊØîËµõÂ∏∏ÂÆ¢</text>
            <view class="candidate-count">5 ‰ΩçÂÄôÈÄâ</view>
            <scroll-view class="candidate-scroll" scroll-x="true">
              <view class="candidate-list">
                <view 
                  v-for="(robot, index) in expertRobots" 
                  :key="index" 
                  class="candidate-item"
                  :class="{ 'selected': selectedRobotId === robot.id }"
                  @click="selectRobot(robot.id)"
                >
                  <image class="candidate-avatar" :src="robot.avatar" mode="aspectFill"></image>
                  <image v-if="robot.locked" class="lock-icon" src="/static/images/robot/lock.png" mode="aspectFit"></image>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>
        
        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <view class="action-button" @click="startGame">
          <text class="button-text">ÂºÄÁé©</text>
        </view>
      </view>
      
      <!-- Êô∫ËÉΩÊïôÁªÉÂØπÊàòÂå∫ -->
      <view v-else class="battle-section">
        <!-- Ê†áÈ¢òÂå∫ -->
        <view class="coach-title">
          <image class="coach-icon" src="https://pic1.imgdb.cn/item/67f3c4fae381c3632bee8f9d.png" mode="aspectFit"></image>
          <text class="coach-heading">Êô∫ËÉΩÊïôÁªÉ</text>
        </view>
        
        <!-- Êú∫Âô®‰∫∫ËÅäÂ§©Ê∞îÊ≥° -->
        <view class="robot-chat-container" v-if="currentRobotMessage">
          <image class="robot-chat-avatar" :src="robotAvatar" mode="aspectFill"></image>
          <view class="speech-bubble">
            <text>{{ currentRobotMessage }}</text>
          </view>
        </view>
        
        <!-- Ê£ãÂ±Ä‰ø°ÊÅØÊ†è -->
        <view class="match-info">
          <view class="opening-info">
            <text class="opening-text">ÂºÄÂ±Ä: {{ openingName }}</text>
            <view class="info-icon">
              <uni-icons type="info" size="18" color="#fff"></uni-icons>
            </view>
          </view>
          
          <!-- Ëµ∞Ê£ãËÆ∞ÂΩï -->
          <view class="moves-record">
            <scroll-view 
              class="moves-scroll" 
              scroll-y="true"
              :scroll-top="scrollTop"
            >
              <view v-if="formattedMoveHistory.length === 0" class="no-moves">
                <text>Ê£ãÂ±ÄÂºÄÂßãÔºåÁ≠âÂæÖÁ¨¨‰∏ÄÊ≠•...</text>
              </view>
              <view 
                v-for="(move, index) in formattedMoveHistory" 
                :key="index"
                class="move-item"
              >
                <text class="move-number">{{ move.moveNumber }}.</text>
                <view class="move-detail">
                  <view class="move-column white-move" v-if="move.white">
                    <view class="move-notation">
                      <image class="piece-icon" :src="getPieceIcon(move.white.piece)" mode="aspectFit"></image>
                      <text>{{ move.white.notation }}</text>
                    </view>
                  </view>
                  <view class="move-column black-move" v-if="move.black">
                    <view class="move-notation">
                      <image class="piece-icon" :src="getPieceIcon(move.black.piece)" mode="aspectFit"></image>
                      <text>{{ move.black.notation }}</text>
                    </view>
                  </view>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>
        
        <!-- ÊéßÂà∂ÊåâÈíÆ -->
        <view class="control-buttons">
          <view class="ctrl-row">
            <view class="ctrl-btn prev-btn" @click="prevMove">
              <text class="btn-icon">‚Üê</text>
            </view>
            <view class="ctrl-btn next-btn" @click="nextMove">
              <text class="btn-icon">‚Üí</text>
            </view>
            <view class="ctrl-btn hint-btn" @click="showHint">
              <text class="btn-icon">üí°</text>
            </view>
            <view class="ctrl-btn resign-btn" @click="resignGame">
              <text class="btn-icon">üè≥Ô∏è</text>
            </view>
          </view>
          <view class="ctrl-row">
            <view class="ctrl-btn restart-btn" @click="restartGame">
              <text>ÈáçÊñ∞ÂºÄÂßã</text>
            </view>
            <view class="ctrl-btn back-btn" @click="backToSelection">
              <text>ÈÄâÊã©ÊïôÁªÉ</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ÁªìÊûúÂºπÁ™ó -->
    <uni-popup ref="victoryPopup" type="center" @change="handleResultClose">
      <view class="result-popup victory-popup">
        <!-- Ê†áÈ¢òÂå∫ -->
        <view class="result-title">
          <text>‰Ω†ÊâìË¥•‰∫Ü</text>
          <text>ÈÇªÂ±ÖÂ§ßÂèîÔºÅ</text>
        </view>
        
        <!-- Áé©ÂÆ∂ÂØπÊàò‰ø°ÊÅØ -->
        <view class="result-players">
          <view class="player-side">
            <image class="player-avatar" :src="robotAvatar" mode="aspectFill"></image>
            <text class="player-name">{{ robotName }}</text>
          </view>
          
          <view class="vs-text">
            <text>VS</text>
          </view>
          
          <view class="player-side">
            <image class="player-avatar" :src="playerAvatar" mode="aspectFill"></image>
            <text class="player-name">{{ playerName }}</text>
          </view>
        </view>
        
        <!-- ÂàÜÊï∞ËØÑÁ∫ß -->
        <view class="result-rating">
          <view class="crown" v-for="i in 3" :key="i"></view>
        </view>
        
        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <view class="result-actions">
          <view class="action-btn primary-btn" @click="restartGame">ÂÜçÊù•‰∏ÄÂ±ÄÔºÅ</view>
          <view class="action-btn secondary-btn" @click="backToSelection">Êç¢‰∏™ÊïôÁªÉ</view>
        </view>
      </view>
    </uni-popup>
    
    <uni-popup ref="defeatPopup" type="center" @change="handleResultClose">
      <view class="result-popup defeat-popup">
        <!-- Ê†áÈ¢òÂå∫ -->
        <view class="result-title">
          <text>ËµµÂæ∑Êü±</text>
          <text>Êãø‰∏ã‰∫ÜÂØπÂ±ÄÔºÅ</text>
        </view>
        
        <!-- Áé©ÂÆ∂ÂØπÊàò‰ø°ÊÅØ -->
        <view class="result-players">
          <view class="player-side winner-side">
            <image class="player-avatar" :src="robotAvatar" mode="aspectFill"></image>
            <view class="winner-mark"></view>
          </view>
          
          <view class="vs-text">
            <text>VS</text>
          </view>
          
          <view class="player-side">
            <image class="player-avatar" :src="playerAvatar" mode="aspectFill"></image>
          </view>
        </view>
        
        <!-- Êìç‰ΩúÊåâÈíÆ -->
        <view class="result-actions">
          <view class="action-btn primary-btn" @click="restartGame">ÂÜçÊù•‰∏ÄÂ±ÄÔºÅ</view>
          <view class="action-btn secondary-btn" @click="backToSelection">Êç¢‰∏™ÊïôÁªÉ</view>
        </view>
      </view>
    </uni-popup>
    
    <uni-popup ref="drawPopup" type="center" @change="handleResultClose">
      <view class="result-popup draw-popup">
        <view class="result-icon">
          <image src="/static/images/match/draw.png" mode="aspectFit"></image>
        </view>
        <view class="result-title">
          <text>ÂíåÊ£ã</text>
        </view>
        <view class="result-description">
          <text>ÂèåÊñπÂÆûÂäõÊóóÈºìÁõ∏ÂΩìÔºÅ</text>
        </view>
        <view class="result-actions">
          <view class="action-btn primary-btn" @click="restartGame">ÂÜçÊù•‰∏ÄÂ±Ä</view>
          <view class="action-btn secondary-btn" @click="backToSelection">Êõ¥Êç¢ÂØπÊâã</view>
        </view>
      </view>
    </uni-popup>
    
    <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
    <tab-bar activeTab="play"></tab-bar>
  </view>
</template>

<script>
import ChessBoard from '@/components/chess/ChessBoard.vue';
import PlayerInfo from '@/components/chess/PlayerInfo.vue';
import TabBar from '@/components/TabBar.vue';
import TopSpacing from '@/components/TopSpacing.vue'
import { 
  getPieceColor, 
  getPieceType, 
  getValidMoves,
  isKingInCheck,
  recordMove,
  resetChessBoardState
} from '@/utils/chess/cheesLogic.js';

export default {
  components: {
    ChessBoard,
    PlayerInfo,
    TabBar,
    TopSpacing
  },
  data() {
    return {
      statusBarHeight: 0,
      // Áé©ÂÆ∂‰ø°ÊÅØ
      playerName: 'Êàë',
      playerAvatar: '/static/images/match/avatar-user.png',
      playerFlag: 'https://pic1.imgdb.cn/item/67f3c5ffe381c3632bee9012.png',
      playerColor: 'white',
      
      // Êú∫Âô®‰∫∫‰ø°ÊÅØ
      robotName: 'ÈÇªÂ±ÖÂ§ßÂèî',
      robotAvatar: '/static/images/robot/neighbor.png',
      robotFlag: 'https://pic1.imgdb.cn/item/67f3c5ffe381c3632bee9012.png',
      robotRating: '1200',
      
      // Ê∏∏ÊàèÁä∂ÊÄÅ
      isRobotTurn: false,
      boardState: this.initBoardState(),
      selectedPosition: null,
      validMoves: [],
      lastMove: null,
      currentPlayer: 'white',
      isCheckmated: false,
      checkmateColor: '',
      
      // Êú∫Âô®‰∫∫ÂàóË°®
      selectedRobotId: 'neighbor',
      casualRobots: [
        { id: 'neighbor', name: 'ÈÇªÂ±ÖÂ§ßÂèî', avatar: 'https://pic1.imgdb.cn/item/67f3c549e381c3632bee8fb8.png', rating: 1200, locked: false },
        { id: 'student', name: 'ÂçïÊ•öÈõÑ', avatar: 'https://pic1.imgdb.cn/item/67f3c549e381c3632bee8fb7.png', rating: 1300, locked: false },
        { id: 'librarian', name: 'ÁÜäÂá∫Â±±', avatar: 'https://pic1.imgdb.cn/item/67f3c4fae381c3632bee8fa1.png', rating: 1400, locked: false },
        { id: 'chef', name: 'Âá∫Â±±ÁÜä', avatar: 'https://pic1.imgdb.cn/item/67f3c4fae381c3632bee8f9e.png', rating: 1500, locked: false },
        { id: 'officer', name: 'Eva', avatar: 'https://pic1.imgdb.cn/item/67f3c549e381c3632bee8fba.png', rating: 1600, locked: true }
      ],
      expertRobots: [
        { id: 'master', name: 'Ë±°Ê£ãÂ§ßÂ∏à', avatar: 'https://pic1.imgdb.cn/item/67f3c549e381c3632bee8fba.png', rating: 1800, locked: true },
        { id: 'professor', name: 'Ë±°Ê£ãÊïôÊéà', avatar: 'https://pic1.imgdb.cn/item/67f3c549e381c3632bee8fb9.png', rating: 1900, locked: true },
        { id: 'champion', name: 'Âú∞Âå∫ÂÜ†ÂÜõ', avatar: 'https://pic1.imgdb.cn/item/67f3c4fae381c3632bee8f9c.png', rating: 2000, locked: true },
        { id: 'grandmaster', name: 'ÁâπÁ∫ßÂ§ßÂ∏à', avatar: 'https://pic1.imgdb.cn/item/67f3c4fae381c3632bee8f9f.png', rating: 2200, locked: true },
        { id: 'legend', name: '‰º†Â•áÊ£ãÊâã', avatar: 'https://pic1.imgdb.cn/item/67f3c4fae381c3632bee8fa0.png', rating: 2500, locked: true }
      ],
      
      // ÁïåÈù¢Áä∂ÊÄÅ
      isSelectionMode: true, // Êñ∞Â¢ûÔºöÂà§Êñ≠ÊòØÂê¶ÊòØÈÄâÊã©Ê®°ÂºèËøòÊòØÂØπÊàòÊ®°Âºè
      
      // ÂØπÊàòÊ®°ÂºèÁöÑÂ±ûÊÄß
      robotMessages: [ // Êú∫Âô®‰∫∫ÂØπËØùÈõÜÂêà
        "ËÆ©ÊàëÊÄùËÄÉ‰∏Ä‰∏ã...",
        "ËøôÊ≠•Ê£ãÂæàÊúâË∂£ÔºÅ",
        "‰Ω†‰∏ãÂæóÂæàÂ•ΩÔºÅ",
        "ÊàëË¶ÅÂÖ®ÂäõÂ∫îÂØπ‰∫Ü„ÄÇ",
        "ÁúãÊù•‰Ω†ÊØîÊàëÂéâÂÆ≥ÂïäÔºÅ",
        "Ëøô‰∏™Â±ÄÈù¢ÂæàÂ§çÊùÇ„ÄÇ",
        "ÊàëÁäØ‰∫Ü‰∏™ÈîôËØØÔºÅ",
        "Âπ≤ÂæóÊºÇ‰∫ÆÔºÅ",
        "ÊàëÂæóÂ∞èÂøÉ‰∏ÄÁÇπ‰∫Ü„ÄÇ",
        "ËøôÊòØ‰∏™Èô∑Èò±ÂêóÔºü"
      ],
      currentRobotMessage: '', // ÂΩìÂâçÊú∫Âô®‰∫∫Ê∂àÊÅØ
      messageTimeout: null, // Ê∂àÊÅØÂÆöÊó∂Âô®
      
      // Ëµ∞Ê£ãËÆ∞ÂΩï
      moveHistory: [],
      formattedMoveHistory: [],
      scrollTop: 0,
      
      // Â§çÁõòÁä∂ÊÄÅ
      isReviewing: false,
      currentMoveIndex: -1,
      originalBoardState: [],
      
      // ÂºÄÂ±ÄÂêçÁß∞
      openingName: 'Ê†áÂáÜÂºÄÂ±Ä',
      
      // Ê∏∏ÊàèÁªìÊùü
      gameOver: false,
      
      // ÁâπÊÆäËµ∞Ê≥ï
      specialMoves: {
        castling: [],  // ÁéãËΩ¶Êòì‰Ωç
        enPassant: null, // ÂêÉËøáË∑ØÂÖµ
        promotion: {   // ÂÖµÂçáÂèò
          pendingMove: null,
          showDialog: false
        }
      },
      
      // ÂçáÂèòÈÄâÈ°π
      promotionOptions: ['queen', 'rook', 'bishop', 'knight'] // ÂèØÈÄâÁöÑÂçáÂèòÊ£ãÂ≠ê
    };
  },
  onLoad() {
    // Ëé∑ÂèñÁä∂ÊÄÅÊ†èÈ´òÂ∫¶
    const systemInfo = uni.getSystemInfoSync()
    this.statusBarHeight = systemInfo.statusBarHeight
    
    // ... existing onLoad code ...
  },
  methods: {
    // ÂàùÂßãÂåñÊ£ãÁõòÁä∂ÊÄÅ
    initBoardState() {
      // ÂàùÂßãÂåñ‰∏Ä‰∏™8x8ÁöÑÊ£ãÁõòÊï∞ÁªÑ
      const board = Array(8).fill().map(() => Array(8).fill(null));
      
      // ËÆæÁΩÆÂàùÂßãÊ£ãÂ≠ê‰ΩçÁΩÆ
      // ÁôΩÊñπÊ£ãÂ≠ê
      board[7][0] = 'white-rook';
      board[7][1] = 'white-knight';
      board[7][2] = 'white-bishop';
      board[7][3] = 'white-queen';
      board[7][4] = 'white-king';
      board[7][5] = 'white-bishop';
      board[7][6] = 'white-knight';
      board[7][7] = 'white-rook';
      for (let i = 0; i < 8; i++) {
        board[6][i] = 'white-pawn';
      }
      
      // ÈªëÊñπÊ£ãÂ≠ê
      board[0][0] = 'black-rook';
      board[0][1] = 'black-knight';
      board[0][2] = 'black-bishop';
      board[0][3] = 'black-queen';
      board[0][4] = 'black-king';
      board[0][5] = 'black-bishop';
      board[0][6] = 'black-knight';
      board[0][7] = 'black-rook';
      for (let i = 0; i < 8; i++) {
        board[1][i] = 'black-pawn';
      }
      
      return board;
    },
    
    // Â§ÑÁêÜÊ£ãÁõòÊ†ºÂ≠êÁÇπÂáª
    handleCellClick(position) {
      // Â¶ÇÊûúÊ∏∏ÊàèÂ∑≤ÁªìÊùüÊàñÊ≠£Âú®Â§çÁõòÔºå‰∏çÂÖÅËÆ∏Êìç‰Ωú
      if (this.gameOver || this.isReviewing) return;
      
      // Â¶ÇÊûúÊòØÊú∫Âô®‰∫∫ÂõûÂêàÔºå‰∏çÂÖÅËÆ∏Êìç‰Ωú
      if (this.isRobotTurn) return;
      
      const { row, col } = position;
      const piece = this.boardState[row][col];
      
      // Â¶ÇÊûúÂ∑≤ÁªèÈÄâ‰∏≠Ê£ãÂ≠êÔºåÂ∞ùËØïÁßªÂä®
      if (this.selectedPosition) {
        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂêå‰∏Ä‰∏™‰ΩçÁΩÆÔºåÂèñÊ∂àÈÄâÊã©
        if (this.selectedPosition.row === row && this.selectedPosition.col === col) {
          this.selectedPosition = null;
          this.validMoves = [];
          return;
        }
        
        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊúâÊïàÁßªÂä®‰ΩçÁΩÆÔºåÊâßË°åÁßªÂä®
        const validMove = this.validMoves.find(move => move.row === row && move.col === col);
        if (validMove) {
          // ÊâßË°åÁßªÂä®
          this.makeMove(this.selectedPosition, position, validMove);
          return;
        }
        
        // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂêåÈ¢úËâ≤ÁöÑÂÖ∂‰ªñÊ£ãÂ≠êÔºåÊõ¥Êñ∞ÈÄâÊã©
        if (piece && getPieceColor(piece) === this.currentPlayer) {
          this.selectPiece(row, col);
          return;
        }
        
        // Âê¶ÂàôÔºåÂèñÊ∂àÈÄâÊã©
        this.selectedPosition = null;
        this.validMoves = [];
      } else {
        // ÈÄâÊã©Ê£ãÂ≠ê
        if (piece && getPieceColor(piece) === this.currentPlayer) {
          this.selectPiece(row, col);
        }
      }
    },
    
    // ÈÄâÊã©Ê£ãÂ≠ê
    selectPiece(row, col) {
      this.selectedPosition = { row, col };
      // Ëé∑ÂèñÊúâÊïàÁßªÂä®
      this.validMoves = getValidMoves(this.boardState, row, col);
    },
    
    // ÁßªÂä®Ê£ãÂ≠ê
    makeMove(from, to, moveInfo = {}) {
      const piece = this.boardState[from.row][from.col];
      if (!piece) return;
      
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÂÖµÂçáÂèò
      const isPawn = getPieceType(piece) === 'pawn';
      const isReachingEnd = (getPieceColor(piece) === 'white' && to.row === 0) || 
                           (getPieceColor(piece) === 'black' && to.row === 7);
      
      if (isPawn && isReachingEnd && !moveInfo.promoteTo) {
        // ÈúÄË¶ÅÊòæÁ§∫ÂçáÂèòÈÄâÊã©
        this.specialMoves.promotion.pendingMove = { from, to };
        this.$refs.promotionPopup.open('center');
        return;
      }
      
      // ËÆ∞ÂΩïË¢´ÂêÉÊéâÁöÑÊ£ãÂ≠ê
      const capturedPiece = this.boardState[to.row][to.col];
      
      // Êõ¥Êñ∞Ê£ãÁõòÁä∂ÊÄÅ
      const move = recordMove(this.boardState, from, to, moveInfo);
      
      // ËÆ∞ÂΩïÊúÄÂêé‰∏ÄÊ≠•ÁßªÂä®
      this.lastMove = move;
      
      // ËÆ∞ÂΩïËµ∞Ê£ãËÆ∞ÂΩï
      this.recordMoveHistory(from, to, piece, capturedPiece, moveInfo);
      
      // Ê†πÊçÆËµ∞Ê£ãÊ≠•Êï∞Êõ¥Êñ∞ÂºÄÂ±ÄÂêçÁß∞
      this.updateOpeningName();
      
      // Ê£ÄÊü•ÊòØÂê¶ÂêÉÊéâÂØπÊñπÁöÑÁéã
      if (capturedPiece && getPieceType(capturedPiece) === 'king') {
        // Ê∏∏ÊàèÁªìÊùü
        this.gameOver = true;
        
        // Á°ÆÂÆöËÉúË¥ü
        const movingColor = getPieceColor(piece);
        const isPlayerWinner = movingColor === this.playerColor;
        
        if (isPlayerWinner) {
          this.showRobotMessage("‰Ω†Ëµ¢‰∫ÜÔºÅ‰Ω†ÂêÉÊéâ‰∫ÜÊàëÁöÑÁéã„ÄÇ");
          // ÊòæÁ§∫Â∞ÜÊùÄÁâπÊïàÂíåËÉúÂà©ÂºπÁ™ó
          if (this.$refs.chessBoard) {
            this.$refs.chessBoard.showCheckmate(true, getPieceColor(capturedPiece));
          }
          setTimeout(() => {
            this.$refs.victoryPopup.open();
          }, 2000);
        } else {
          this.showRobotMessage("Â∞ÜÂÜõÔºÅÊàëËµ¢‰∫Ü„ÄÇ");
          // ÊòæÁ§∫Â∞ÜÊùÄÁâπÊïàÂíåÂ§±Ë¥•ÂºπÁ™ó
          if (this.$refs.chessBoard) {
            this.$refs.chessBoard.showCheckmate(true, getPieceColor(capturedPiece));
          }
          setTimeout(() => {
            this.$refs.defeatPopup.open();
          }, 2000);
        }
        
        // ‰∏çÁªßÁª≠ÊâßË°åÂêéÁª≠ÈÄªËæë
        return;
      }
      
      // Â¶ÇÊûúÊúâÂêÉÂ≠êÔºåÊú∫Âô®‰∫∫ÂèØËÉΩËØ¥ËØù
      if (capturedPiece) {
        if (getPieceColor(piece) === this.playerColor) {
          // Áé©ÂÆ∂ÂêÉ‰∫ÜÊú∫Âô®‰∫∫ÁöÑÂ≠ê
          this.showRobotMessage(this.getRandomCapturedMessage());
        } else {
          // Êú∫Âô®‰∫∫ÂêÉ‰∫ÜÁé©ÂÆ∂ÁöÑÂ≠ê
          this.showRobotMessage(this.getRandomCapturingMessage());
        }
      }
      
      // ÂàáÊç¢Áé©ÂÆ∂
      this.currentPlayer = this.currentPlayer === 'white' ? 'black' : 'white';
      this.isRobotTurn = !this.isRobotTurn;
      
      // Ê£ÄÊü•Ê∏∏ÊàèÁªìÂ±Ä
      this.checkGameOutcome();
      
      // Â¶ÇÊûúËΩÆÂà∞Êú∫Âô®‰∫∫ÔºåÊ®°ÊãüÊú∫Âô®‰∫∫ÊÄùËÄÉÂíåËµ∞Ê£ã
      if (!this.gameOver && this.isRobotTurn) {
        setTimeout(() => {
          this.robotMove();
        }, 1500);
      }
      
      // ÈáçÁΩÆÈÄâÊã©Áä∂ÊÄÅ
      this.selectedPosition = null;
      this.validMoves = [];
    },
    
    // Êú∫Âô®‰∫∫Ëµ∞Ê£ãÔºàÁÆÄÂåñÁâàÔºåÂèØ‰ª•Ê†πÊçÆÈöæÂ∫¶Á∫ßÂà´Ë∞ÉÊï¥Ôºâ
    robotMove() {
      // ÊòæÁ§∫ÊÄùËÄÉ‰∏≠Ê∂àÊÅØ
      this.showRobotMessage("ËÆ©ÊàëÊÄùËÄÉ‰∏Ä‰∏ã...");
      
      setTimeout(() => {
        // Ëé∑ÂèñÊâÄÊúâÊú∫Âô®‰∫∫ÁöÑÊ£ãÂ≠ê
        const robotPieces = [];
        for (let row = 0; row < 8; row++) {
          for (let col = 0; col < 8; col++) {
            const piece = this.boardState[row][col];
            if (piece && getPieceColor(piece) === this.currentPlayer) {
              robotPieces.push({ row, col });
            }
          }
        }
        
        // ‰∏∫ÊØè‰∏™Ê£ãÂ≠êËÆ°ÁÆóÂèØËÉΩÁöÑÁßªÂä®
        let allMoves = [];
        robotPieces.forEach(piece => {
          const moves = getValidMoves(this.boardState, piece.row, piece.col);
          moves.forEach(move => {
            allMoves.push({
              from: piece,
              to: move,
              score: this.evaluateMove(piece, move)
            });
          });
        });
        
        // Ê†πÊçÆÂàÜÊï∞ÊéíÂ∫èÁßªÂä®
        allMoves.sort((a, b) => b.score - a.score);
        
        if (allMoves.length > 0) {
          // ÈÄâÊã©ÂæóÂàÜÊúÄÈ´òÁöÑÁßªÂä®ÔºàÊ∑ªÂä†‰∏Ä‰∫õÈöèÊú∫ÊÄßÔºå‰∏çÊÄªÊòØÈÄâÊúÄ‰Ω≥Ôºâ
          const topMoves = allMoves.slice(0, Math.min(3, allMoves.length));
          const selectedMoveIndex = Math.floor(Math.random() * topMoves.length);
          const selectedMove = topMoves[selectedMoveIndex];
          
          // ÊâßË°åÁßªÂä®
          this.makeMove(selectedMove.from, selectedMove.to);
        } else {
          // Ê≤°ÊúâÂèØË°åÁöÑÁßªÂä®ÔºåÊ∏∏ÊàèÁªìÊùü
          this.handleCheckmate(); // ÊàñËÄÖÂíåÊ£ã
        }
      }, 1000); // ÊÄùËÄÉÊó∂Èó¥
    },
    
    // ËØÑ‰º∞ÁßªÂä®ÁöÑÂæóÂàÜÔºàÁÆÄÂçïÁâàÊú¨ÔºåÂèØÊ†πÊçÆÈúÄË¶ÅÊâ©Â±ïÔºâ
    evaluateMove(from, to) {
      let score = 0;
      const piece = this.boardState[from.row][from.col];
      const targetPiece = this.boardState[to.row][to.col];
      
      // Âü∫Êú¨Á≠ñÁï•ÔºöÂêÉÂ≠êÊØî‰∏çÂêÉÂ≠êÂ•Ω
      if (targetPiece) {
        // Ê†πÊçÆË¢´ÂêÉÊ£ãÂ≠êÁöÑ‰ª∑ÂÄºËØÑÂàÜ
        score += this.getPieceValue(targetPiece);
      }
      
      // ‰∏≠ÂøÉÊéßÂà∂
      const centerDistance = Math.abs(to.row - 3.5) + Math.abs(to.col - 3.5);
      score += (4 - centerDistance) * 0.1; // Ë∂äÈù†Ëøë‰∏≠ÂøÉÂàÜÊï∞Ë∂äÈ´ò
      
      // ÈöèÊú∫Âõ†Á¥†ÔºåÂ¢ûÂä†Ê∏∏ÊàèÂèòÂåñÊÄß
      score += Math.random() * 0.5;
      
      return score;
    },
    
    // Ëé∑ÂèñÊ£ãÂ≠ê‰ª∑ÂÄº
    getPieceValue(piece) {
      const type = getPieceType(piece);
      switch (type) {
        case 'pawn': return 1;
        case 'knight': return 3;
        case 'bishop': return 3;
        case 'rook': return 5;
        case 'queen': return 9;
        case 'king': return 100; // ÊûÅÈ´òÂÄºÁ°Æ‰øù‰ºòÂÖà‰øùÊä§Áéã
        default: return 0;
      }
    },
    
    // Ê£ÄÊü•Ê∏∏ÊàèÁªìÂ±Ä
    checkGameOutcome() {
      // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ∞ÜÂÜõ
      const isCheck = isKingInCheck(this.boardState, this.currentPlayer);
      
      if (isCheck) {
        // Â¶ÇÊûúÊòØÂ∞ÜÂÜõÔºåÊ£ÄÊü•ÊòØÂê¶Â∞ÜÊùÄ
        const hasLegalMove = this.hasAnyLegalMove();
        
        if (!hasLegalMove) {
          // Â∞ÜÊùÄ
          this.handleCheckmate();
        } else {
          // ‰ªÖÊòØÂ∞ÜÂÜõ
          if (this.currentPlayer === this.playerColor) {
            this.showRobotMessage("Â∞ÜÂÜõÔºÅÂ∞èÂøÉ‰Ω†ÁöÑÁéã„ÄÇ");
            if (this.$refs.chessBoard) {
              this.$refs.chessBoard.showCheckmate(false, this.currentPlayer);
            }
          } else {
            this.showRobotMessage("ÂìàÂìàÔºåÂ∞ÜÂÜõÔºÅ");
            if (this.$refs.chessBoard) {
              this.$refs.chessBoard.showCheckmate(false, this.currentPlayer);
            }
          }
        }
      } else {
        // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÈÄºÂíåÔºàÊó†Â≠êÂèØÂä®Ôºâ
        const hasLegalMove = this.hasAnyLegalMove();
        if (!hasLegalMove) {
          // ÈÄºÂíå
          this.handleStalemate();
        }
      }
    },
    
    // Ê£ÄÊü•ÂΩìÂâçÁé©ÂÆ∂ÊòØÂê¶Êúâ‰ªª‰ΩïÂêàÊ≥ïÁßªÂä®
    hasAnyLegalMove() {
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          const piece = this.boardState[row][col];
          if (piece && getPieceColor(piece) === this.currentPlayer) {
            const moves = getValidMoves(this.boardState, row, col);
            if (moves.length > 0) {
              return true;
            }
          }
        }
      }
      return false;
    },
    
    // Â§ÑÁêÜÂ∞ÜÊùÄ
    handleCheckmate() {
      // ËÆæÁΩÆÊ∏∏ÊàèÁªìÊùüÁä∂ÊÄÅ
      this.gameOver = true;
      this.isCheckmated = true;
      this.checkmateColor = this.currentPlayer;
      
      // Á°ÆÂÆöËÉúË¥üÊñπ
      const isPlayerWin = this.checkmateColor !== this.playerColor;
      
      // ÊòæÁ§∫Â∞ÜÊùÄÂä®Áîª
      if (this.$refs.chessBoard) {
        this.$refs.chessBoard.showCheckmate(true, this.checkmateColor);
      }
      
      // Êú∫Âô®‰∫∫ËØ¥ËØù
      if (isPlayerWin) {
        this.showRobotMessage("‰Ω†ÁúüÂéâÂÆ≥ÔºÅÊàëËÆ§Ëæì‰∫Ü„ÄÇ");
      } else {
        this.showRobotMessage("Â∞ÜÂÜõÔºÅÊàëËµ¢‰∫ÜËøôÂ±Ä„ÄÇ");
      }
      
      // ÊòæÁ§∫ÁªìÊûúÂºπÁ™ó
      setTimeout(() => {
        if (isPlayerWin) {
          this.$refs.victoryPopup.open();
        } else {
          this.$refs.defeatPopup.open();
        }
      }, 2000);
    },
    
    // Â§ÑÁêÜÈÄºÂíå
    handleStalemate() {
      // ËÆæÁΩÆÊ∏∏ÊàèÁªìÊùüÁä∂ÊÄÅ
      this.gameOver = true;
      
      // ÊòæÁ§∫ÂíåÊ£ãÊ∂àÊÅØ
      this.showRobotMessage("ÁúãÊù•ÊòØÂπ≥Â±Ä‰∫ÜÔºÅ");
      
      // ÊòæÁ§∫ÂíåÊ£ãÂºπÁ™ó
      setTimeout(() => {
        this.$refs.drawPopup.open();
      }, 1500);
    },
    
    // ÊäïÈôçÊ∏∏Êàè
    resignGame() {
      // Ê∏∏ÊàèÁªìÊùü
      this.gameOver = true;
      this.showRobotMessage("‰∏çË¶ÅÊ∞îÈ¶ÅÔºå‰∏ãÊ¨°ÂÜçÊù•ÊåëÊàòÂêßÔºÅ");
      
      // ÊòæÁ§∫Â§±Ë¥•ÂºπÁ™ó
      setTimeout(() => {
        this.$refs.defeatPopup.open();
      }, 1000);
    },
    
    // ÊòæÁ§∫ÊèêÁ§∫
    showHint() {
      if (this.gameOver || this.isReviewing || this.isRobotTurn) return;
      
      // Êü•ÊâæÁé©ÂÆ∂ÂΩìÂâçÂèØÁî®ÁöÑÊúÄ‰Ω≥ÁßªÂä®
      const bestMove = this.findBestPlayerMove();
      if (bestMove) {
        // È´ò‰∫ÆÊèêÁ§∫ÁöÑËµ∑Âßã‰ΩçÁΩÆ
        this.selectPiece(bestMove.from.row, bestMove.from.col);
        
        // Êú∫Âô®‰∫∫ÁªôÂá∫ÊèêÁ§∫
        this.showRobotMessage("ÊàëÂª∫ËÆÆ‰Ω†ËÄÉËôëËøô‰∏™‰ΩçÁΩÆÁöÑÊ£ãÂ≠ê„ÄÇ");
      }
    },
    
    // ÂØªÊâæÁé©ÂÆ∂ÊúÄ‰Ω≥ÁßªÂä®
    findBestPlayerMove() {
      // Ëé∑ÂèñÊâÄÊúâÁé©ÂÆ∂ÁöÑÊ£ãÂ≠ê
      const playerPieces = [];
      for (let row = 0; row < 8; row++) {
        for (let col = 0; col < 8; col++) {
          const piece = this.boardState[row][col];
          if (piece && getPieceColor(piece) === this.currentPlayer) {
            playerPieces.push({ row, col });
          }
        }
      }
      
      // ‰∏∫ÊØè‰∏™Ê£ãÂ≠êËÆ°ÁÆóÂèØËÉΩÁöÑÁßªÂä®
      let allMoves = [];
      playerPieces.forEach(piece => {
        const moves = getValidMoves(this.boardState, piece.row, piece.col);
        moves.forEach(move => {
          allMoves.push({
            from: piece,
            to: move,
            score: this.evaluateMove(piece, move)
          });
        });
      });
      
      // Ê†πÊçÆÂàÜÊï∞ÊéíÂ∫èÁßªÂä®
      allMoves.sort((a, b) => b.score - a.score);
      
      return allMoves.length > 0 ? allMoves[0] : null;
    },
    
    // Â§ÑÁêÜÂçáÂèòÈÄâÊã©
    selectPromotionPiece(pieceType) {
      // ÂÖ≥Èó≠ÂçáÂèòÂºπÁ™ó
      this.$refs.promotionPopup.close();
      
      const pendingMove = this.specialMoves.promotion.pendingMove;
      if (!pendingMove) return;
      
      // ÊâßË°åÂ∏¶ÊúâÂçáÂèò‰ø°ÊÅØÁöÑÁßªÂä®
      this.makeMove(pendingMove.from, pendingMove.to, { 
        promoteTo: pieceType,
        isPromotion: true
      });
      
      // Ê∏ÖÈô§ÂçáÂèòÁä∂ÊÄÅ
      this.specialMoves.promotion.pendingMove = null;
      
      // Êú∫Âô®‰∫∫ÂèØËÉΩÂØπÊ≠§ËØÑËÆ∫
      this.showRobotMessage("ÂìáÔºÅ‰Ω†Ëé∑Âæó‰∫Ü‰∏Ä‰∏™Âº∫Â§ßÁöÑÊ£ãÂ≠êÔºÅ");
    },
    
    // ËÆ∞ÂΩïËµ∞Ê£ãÂéÜÂè≤
    recordMoveHistory(from, to, piece, captured, moveInfo = {}) {
      const pieceType = getPieceType(piece);
      const pieceColor = getPieceColor(piece);
      
      // ËÆ°ÁÆó‰ª£Êï∞ËÆ∞Ë∞±Ê≥ïË°®Á§∫
      const notation = this.calculateNotation(from, to, piece, captured, moveInfo);
      
      // Â≠òÂÇ®ÂÆåÊï¥ÁßªÂä®‰ø°ÊÅØ
      this.moveHistory.push({
        piece: piece,
        from: from,
        to: to,
        captured: captured,
        notation: notation,
        ...moveInfo
      });
      
      // Êõ¥Êñ∞Ê†ºÂºèÂåñÁöÑÂéÜÂè≤ËÆ∞ÂΩï
      if (pieceColor === 'white') {
        this.formattedMoveHistory.push({
          moveNumber: this.formattedMoveHistory.length + 1,
          white: {
            notation: notation,
            piece: piece
          },
          black: null
        });
      } else {
        const lastMove = this.formattedMoveHistory[this.formattedMoveHistory.length - 1];
        if (lastMove && lastMove.black === null) {
          lastMove.black = {
            notation: notation,
            piece: piece
          };
        } else {
          // Â§ÑÁêÜÈªëÊñπÂÖàË°åÁöÑÊÉÖÂÜµ
          this.formattedMoveHistory.push({
            moveNumber: this.formattedMoveHistory.length + 1,
            white: null,
            black: {
              notation: notation,
              piece: piece
            }
          });
        }
      }
      
      // Êõ¥Êñ∞ÊªöÂä®‰ΩçÁΩÆ
      this.$nextTick(() => {
        this.scrollTop = 9999; // ÊªöÂä®Âà∞Â∫ïÈÉ®
      });
    },
    
    // ËÆ°ÁÆó‰ª£Êï∞ËÆ∞Ë∞±Ê≥ï
    calculateNotation(from, to, piece, captured, moveInfo = {}) {
      const pieceType = getPieceType(piece);
      const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
      const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
      
      // ÁâπÊÆäÊÉÖÂÜµÔºöÁéãËΩ¶Êòì‰Ωç
      if (pieceType === 'king' && Math.abs(from.col - to.col) > 1) {
        return to.col > from.col ? 'O-O' : 'O-O-O'; // Áü≠Êòì‰ΩçÂíåÈïøÊòì‰Ωç
      }
      
      let notation = '';
      
      // Ê∑ªÂä†Ê£ãÂ≠êÁ±ªÂûãÁ¨¶Âè∑ÔºàÈô§‰∫ÜÂÖµÔºâ
      if (pieceType !== 'pawn') {
        const symbols = {
          'king': 'K',
          'queen': 'Q',
          'rook': 'R',
          'bishop': 'B',
          'knight': 'N'
        };
        notation += symbols[pieceType];
      } else if (captured) {
        // ÂÖµÂêÉÂ≠êÊó∂ÔºåÂä†‰∏äËµ∑ÂßãÂàó
        notation += files[from.col];
      }
      
      // Ê∑ªÂä†ÂêÉÂ≠êÁ¨¶Âè∑
      if (captured || moveInfo.isEnPassant) {
        notation += 'x';
      }
      
      // Ê∑ªÂä†ÁõÆÊ†á‰ΩçÁΩÆ
      notation += files[to.col] + ranks[to.row];
      
      // Ê∑ªÂä†ÂçáÂèò‰ø°ÊÅØ
      if (moveInfo.isPromotion) {
        const promotePiece = moveInfo.promoteTo || 'queen';
        const symbols = {
          'queen': 'Q',
          'rook': 'R',
          'bishop': 'B',
          'knight': 'N'
        };
        notation += '=' + symbols[promotePiece];
      }
      
      // TODO: Ê∑ªÂä†Â∞ÜÂÜõÂíåÂ∞ÜÊùÄÁ¨¶Âè∑
      
      return notation;
    },
    
    // Ëé∑ÂèñÊ£ãÂ≠êÂõæÊ†á
    getPieceIcon(piece) {
      if (!piece) return '';
      return `/static/images/match/pieces/${piece}.png`;
    },
    
    // ÊòæÁ§∫Êú∫Âô®‰∫∫Ê∂àÊÅØ
    showRobotMessage(message) {
      // Ê∏ÖÈô§‰πãÂâçÁöÑÊ∂àÊÅØË∂ÖÊó∂
      if (this.messageTimeout) {
        clearTimeout(this.messageTimeout);
      }
      
      this.currentRobotMessage = message;
      
      // ËÆæÁΩÆÊ∂àÊÅØÊòæÁ§∫Êó∂Èó¥
      this.messageTimeout = setTimeout(() => {
        this.currentRobotMessage = '';
      }, 5000);
    },
    
    // Ëé∑ÂèñÈöèÊú∫Ë¢´ÂêÉÂ≠êÊ∂àÊÅØ
    getRandomCapturedMessage() {
      const messages = [
        "ÂïäÔºÅÊàëÁöÑÊ£ãÂ≠êÔºÅ",
        "ÂìéÂëÄÔºåÊàëÂæóÂ∞èÂøÉÁÇπ„ÄÇ",
        "ÁúãÊù•‰Ω†ÊØîÊàëÂéâÂÆ≥ÂïäÔºÅ",
        "Â•ΩÊ£ãÔºÅ",
        "ËøôÊ≠•ÊàëÊ≤°ËÄÉËôëÂà∞„ÄÇ"
      ];
      return messages[Math.floor(Math.random() * messages.length)];
    },
    
    // Ëé∑ÂèñÈöèÊú∫ÂêÉÂ≠êÊ∂àÊÅØ
    getRandomCapturingMessage() {
      const messages = [
        "ÂìàÔºÅÊàëÊãø‰∏ã‰∫Ü‰Ω†ÁöÑÊ£ãÂ≠ê„ÄÇ",
        "ËøôÊ≠•‰Ω†Ê≤°ÁúãÂà∞ÂêßÔºü",
        "ÁúãÊàëÁöÑÂéâÂÆ≥ÔºÅ",
        "ÊàëÊâæÂà∞‰∫Ü‰∏Ä‰∏™Â•ΩÊú∫‰ºö„ÄÇ",
        "ËøôÊòØÊàòÊúØ‰∫§Êç¢„ÄÇ"
      ];
      return messages[Math.floor(Math.random() * messages.length)];
    },
    
    // Â§ÑÁêÜÁªìÊûúÂºπÁ™óÂÖ≥Èó≠
    handleResultClose(e) {
      // ÂºπÁ™óÂÖ≥Èó≠‰∫ã‰ª∂Â§ÑÁêÜ
      console.log('ÁªìÊûúÂºπÁ™óÂÖ≥Èó≠');
    },
    
    // Êõ¥Êñ∞ÂºÄÂ±ÄÂêçÁß∞
    updateOpeningName() {
      // Ê†πÊçÆÂΩìÂâçÁöÑËµ∞Ê£ãËÆ∞ÂΩïÂíåÂ±ÄÈù¢Âà§Êñ≠ÂºÄÂ±ÄÂêçÁß∞
      // ËøôÈáåÂè™ÊòØ‰∏Ä‰∏™ÁÆÄÂçïÁ§∫‰æãÔºåÂÆûÈôÖ‰∏äÂèØ‰ª•ÊúâÊõ¥Â§çÊùÇÁöÑÂºÄÂ±ÄÊï∞ÊçÆÂ∫ì
      const moveCount = this.moveHistory.length;
      
      if (moveCount < 2) {
        this.openingName = 'Ê†áÂáÜÂºÄÂ±Ä';
      } else if (moveCount === 2) {
        // Ëé∑ÂèñÁ¨¨‰∏ÄÊ≠•ÁöÑÁßªÂä®
        const firstMove = this.moveHistory[0];
        if (firstMove && getPieceType(firstMove.piece) === 'pawn') {
          // Ê£ÄÊü•ÊòØÂê¶ÊòØÁéãÁøºÂÖµÂºÄÂ±Ä
          if (firstMove.from.col === 4 && firstMove.to.col === 4) {
            this.openingName = 'ÁéãÂêéÂÖµÂºÄÂ±Ä';
          } else if (firstMove.from.col === 3 && firstMove.to.col === 3) {
            this.openingName = 'ÁéãÂÖµÂºÄÂ±Ä';
          }
        }
      } else if (moveCount === 4) {
        // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Êõ¥Â§öÂºÄÂ±ÄÂà§Êñ≠
        const firstMoves = this.moveHistory.slice(0, 4);
        const pawnMoves = firstMoves.filter(move => getPieceType(move.piece) === 'pawn');
        const knightMoves = firstMoves.filter(move => getPieceType(move.piece) === 'knight');
        
        if (knightMoves.length >= 2) {
          this.openingName = 'ÂèåÈ™ëÂ£´ÂºÄÂ±Ä';
        } else if (pawnMoves.length === 4) {
          this.openingName = 'ÂèåÂÖµÂºÄÂ±Ä';
        }
      } else if (moveCount === 6) {
        // Êõ¥Â§öÂ§çÊùÇÂºÄÂ±ÄÂèØ‰ª•Âú®ËøôÈáåÂà§Êñ≠
        // ‰æãÂ¶ÇË•øË•øÈáåÈò≤Âæ°„ÄÅÊ≥ïÂõΩÈò≤Âæ°Á≠â
        this.openingName = 'ÂèëÂ±ïÂºÄÂ±Ä';
      }
    },
    
    // Â§çÁõòÊìç‰Ωú - Ââç‰∏ÄÊ≠•
    prevMove() {
      if (this.moveHistory.length === 0) return;
      
      if (!this.isReviewing) {
        // Á¨¨‰∏ÄÊ¨°ËøõÂÖ•Â§çÁõòÊ®°Âºè
        this.isReviewing = true;
        this.originalBoardState = JSON.parse(JSON.stringify(this.boardState));
        this.currentMoveIndex = this.moveHistory.length - 1;
      } else if (this.currentMoveIndex > 0) {
        // ÂêëÂâçÂõûÈÄÄ‰∏ÄÊ≠•
        this.currentMoveIndex--;
      } else {
        // Â∑≤ÁªèÂà∞ÂàùÂßã‰ΩçÁΩÆ
        this.currentMoveIndex = -1;
        this.rebuildBoardToMove(this.currentMoveIndex);
        return;
      }
      
      // ÈáçÂª∫Âà∞ÊåáÂÆöÊ≠•È™§ÁöÑÊ£ãÁõò
      this.rebuildBoardToMove(this.currentMoveIndex);
      
      // ÊòæÁ§∫Â§çÁõòÊ∂àÊÅØ
      this.showRobotMessage("Ê≠£Âú®Â§çÁõò: Á¨¨" + (this.currentMoveIndex + 1) + "Ê≠•");
    },
    
    // Â§çÁõòÊìç‰Ωú - Âêé‰∏ÄÊ≠•
    nextMove() {
      if (this.moveHistory.length === 0) return;
      
      if (!this.isReviewing) {
        // Êú™Â§Ñ‰∫éÂ§çÁõòÊ®°Âºè
        return;
      }
      
      if (this.currentMoveIndex < this.moveHistory.length - 1) {
        // ÂêëÂêéÂâçËøõ‰∏ÄÊ≠•
        this.currentMoveIndex++;
        this.rebuildBoardToMove(this.currentMoveIndex);
        
        // ÊòæÁ§∫Â§çÁõòÊ∂àÊÅØ
        this.showRobotMessage("Ê≠£Âú®Â§çÁõò: Á¨¨" + (this.currentMoveIndex + 1) + "Ê≠•");
      } else if (this.currentMoveIndex === this.moveHistory.length - 1) {
        // Â∑≤ÁªèÊòØÊúÄÂêé‰∏ÄÊ≠•ÔºåÈÄÄÂá∫Â§çÁõòÊ®°Âºè
        this.isReviewing = false;
        this.boardState = JSON.parse(JSON.stringify(this.originalBoardState));
        this.currentMoveIndex = -1;
        
        // ÊòæÁ§∫ÈÄÄÂá∫Â§çÁõòÊ∂àÊÅØ
        this.showRobotMessage("Â∑≤ÈÄÄÂá∫Â§çÁõòÊ®°Âºè");
      }
    },
    
    // ÈáçÂª∫Ê£ãÁõòÂà∞ÊåáÂÆöÊ≠•È™§
    rebuildBoardToMove(moveIndex) {
      // ‰ªéÂàùÂßãÊ£ãÁõòÂºÄÂßãÈáçÂª∫
      const newBoard = this.initBoardState();
      
      if (moveIndex < 0) {
        // ÂõûÂà∞ÂàùÂßãÁä∂ÊÄÅ
        this.boardState = newBoard;
        return;
      }
      
      // Â∫îÁî®Âà∞ÊåáÂÆöÊ≠•È™§ÁöÑÊâÄÊúâÁßªÂä®
      for (let i = 0; i <= moveIndex; i++) {
        const move = this.moveHistory[i];
        if (move) {
          // Â∫îÁî®ÁßªÂä®
          recordMove(newBoard, move.from, move.to, {
            isPromotion: move.isPromotion,
            promoteTo: move.promoteTo,
            isCastling: move.isCastling,
            rookFrom: move.rookFrom,
            rookTo: move.rookTo,
            isEnPassant: move.isEnPassant,
            capturedPiecePos: move.capturedPiecePos
          });
        }
      }
      
      // Êõ¥Êñ∞Ê£ãÁõòÁä∂ÊÄÅ
      this.boardState = newBoard;
    },
    
    // ÈáçÊñ∞ÂºÄÂßãÊ∏∏Êàè
    restartGame() {
      // ÂÖ≥Èó≠ÊâÄÊúâÂºπÁ™ó
      if (this.$refs.victoryPopup) this.$refs.victoryPopup.close();
      if (this.$refs.defeatPopup) this.$refs.defeatPopup.close();
      if (this.$refs.drawPopup) this.$refs.drawPopup.close();
      
      // ÈáçÊñ∞ÂàùÂßãÂåñÊ∏∏Êàè
      this.initGame();
    },
    
    // ËøîÂõûÂà∞ÈÄâÊã©ÁïåÈù¢
    backToSelection() {
      // ÂàáÊç¢ÂõûÈÄâÊã©Ê®°Âºè
      this.isSelectionMode = true;
    },
    
    // ÈÄâÊã©Êú∫Âô®‰∫∫
    selectRobot(robotId) {
      // Ê£ÄÊü•Êú∫Âô®‰∫∫ÊòØÂê¶ÈîÅÂÆö
      const casualRobot = this.casualRobots.find(robot => robot.id === robotId);
      const expertRobot = this.expertRobots.find(robot => robot.id === robotId);
      const robot = casualRobot || expertRobot;
      
      if (robot && robot.locked) {
        uni.showToast({
          title: 'ËØ•Êú∫Âô®‰∫∫Â∞öÊú™Ëß£ÈîÅ',
          icon: 'none'
        });
        return;
      }
      
      this.selectedRobotId = robotId;
      
      // Êõ¥Êñ∞ÈÄâ‰∏≠ÁöÑÊú∫Âô®‰∫∫‰ø°ÊÅØ
      if (robot) {
        this.robotName = robot.name;
        this.robotAvatar = robot.avatar;
        this.robotRating = robot.rating;
      }
    },
    
    // ÂºÄÂßãÊ∏∏Êàè
    startGame() {
      // ÊâæÂà∞ÈÄâ‰∏≠ÁöÑÊú∫Âô®‰∫∫‰ø°ÊÅØ
      const selectedRobot = [...this.casualRobots, ...this.expertRobots].find(robot => robot.id === this.selectedRobotId);
      
      if (!selectedRobot) {
        uni.showToast({
          title: 'ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Êú∫Âô®‰∫∫',
          icon: 'none'
        });
        return;
      }
      
      // Êõ¥Êñ∞Êú∫Âô®‰∫∫‰ø°ÊÅØ
      this.robotName = selectedRobot.name;
      this.robotAvatar = selectedRobot.avatar;
      this.robotRating = selectedRobot.rating;
      
      // ÂàáÊç¢Âà∞ÂØπÊàòÊ®°Âºè
      this.isSelectionMode = false;
      
      // ÂàùÂßãÂåñÊ∏∏Êàè
      this.initGame();
    },
    
    // ÂàùÂßãÂåñÊ∏∏Êàè
    initGame() {
      // ÂàùÂßãÂåñÊ£ãÁõòÁä∂ÊÄÅ
      this.boardState = this.initBoardState();
      this.originalBoardState = JSON.parse(JSON.stringify(this.boardState));
      
      // ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
      this.selectedPosition = null;
      this.validMoves = [];
      this.lastMove = null;
      this.currentPlayer = 'white';
      this.isCheckmated = false;
      this.checkmateColor = '';
      this.gameOver = false;
      this.isRobotTurn = this.playerColor === 'black';
      
      // ÈáçÁΩÆËµ∞Ê£ãËÆ∞ÂΩï
      this.moveHistory = [];
      this.formattedMoveHistory = [];
      this.scrollTop = 0;
      this.openingName = 'Ê†áÂáÜÂºÄÂ±Ä';
      
      // ÈáçÁΩÆÂ§çÁõòÁä∂ÊÄÅ
      this.isReviewing = false;
      this.currentMoveIndex = -1;
      
      // Ê∏ÖÈô§Êú∫Âô®‰∫∫Ê∂àÊÅØ
      this.currentRobotMessage = '';
      if (this.messageTimeout) {
        clearTimeout(this.messageTimeout);
      }
      
      // ÈáçÁΩÆÁâπÊÆäËµ∞Ê≥ïÁä∂ÊÄÅ
      this.specialMoves.castling = [];
      this.specialMoves.enPassant = null;
      this.specialMoves.promotion.pendingMove = null;
      this.specialMoves.promotion.showDialog = false;
      
      // ÈáçÁΩÆÊ£ãÁõòÁâπÊÆäÁä∂ÊÄÅ
      resetChessBoardState();
      
      // Â¶ÇÊûúÁé©ÂÆ∂ÊâßÈªëÔºåÊú∫Âô®‰∫∫ÂÖàË°å
      if (this.playerColor === 'black') {
        setTimeout(() => {
          this.robotMove();
        }, 1000);
      } else {
        // ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ
        this.showRobotMessage("Ê¨¢ËøéÊåëÊàòÔºÅËØ∑ÂÖàË°åÂä®Âêß„ÄÇ");
      }
    }
  }
}
</script>

<style lang="scss" scoped>
.robot-container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  background-image: url('https://pic1.imgdb.cn/item/67f356300ba3d5a1d7ef164f.png');
  background-size: cover;
  background-position: center;
}

.main-content {
  padding: 30rpx;
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* Ê£ãÁõòÂØπÊàòÂå∫Ê†∑Âºè */
.chess-section {
  padding: 20rpx;
  border-radius: 20rpx;
  margin-bottom: 20rpx;
}

.player-info-container {
  display: flex;
  flex-direction: column;
  gap: 20rpx;
  
  .board-container {
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
}

/* Êô∫ËÉΩÊïôÁªÉÂäüËÉΩÂå∫Ê†∑Âºè */
.coach-section {
  flex: 1;
  padding: 30rpx;
  background-color: rgba(0, 0, 0, 0.3);
  border-radius: 20rpx;
  margin-bottom: 100rpx;
  display: flex;
  flex-direction: column;
}

.coach-title {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 30rpx;
  
  .coach-icon {
    width: 48rpx;
    height: 48rpx;
    margin-right: 10rpx;
  }
  
  .coach-heading {
    font-size: 36rpx;
    color: #EEE;
    font-weight: bold;
  }
}

.robot-intro {
  display: flex;
  margin-bottom: 30rpx;
  
  .robot-avatar {
    width: 120rpx;
    height: 120rpx;
    border-radius: 60rpx;
    margin-right: 20rpx;
  }
  
  .robot-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    
    .speech-bubble {
      background-color: #FFFFFF;
      border-radius: 20rpx;
      padding: 30rpx;
      margin: 20rpx;
      position: relative;
      box-shadow: 0 2rpx 6rpx rgba(0, 0, 0, 0.1);
      
      &:before {
        content: '';
        position: absolute;
        left: -12rpx;
        top: 30rpx;
        width: 0;
        height: 0;
        border-top: 12rpx solid transparent;
        border-right: 20rpx solid #FFFFFF;
        border-bottom: 12rpx solid transparent;
      }
      
      text {
        font-size: 28rpx;
        color: #333;
      }
    }
    
    .robot-info {
      display: flex;
      align-items: center;
      margin-top: 10rpx;
      
      .robot-name {
        font-size: 32rpx;
        color: #EEE;
        font-weight: bold;
        margin-right: 16rpx;
      }
      
      .robot-rating {
        font-size: 28rpx;
        color: #666666;
        margin-right: 10rpx;
      }
      
      .robot-flag {
        width: 40rpx;
        height: 40rpx;
      }
    }
  }
}

.robot-candidates {
  margin : 40rpx auto;
  padding: 20rpx;
  width: 100%;
  background-color: rgba(0, 0, 0, 0.3);
  .candidate-group {
    margin-bottom: 40rpx;
    position: relative;
    
    .group-title {
      font-size: 32rpx;
      color: #EEE;
      margin-left: 20rpx;
      font-weight: bold;
      margin-bottom: 20rpx;
    }
    
    .candidate-count {
      position: absolute;
      top: 0;
      right: 20rpx;
      font-size: 24rpx;
      color: #999;
    }
    
    .candidate-scroll {
      margin-top: 20rpx;
      width: 100%;
    }
    
    .candidate-list {
      display: flex;
      padding: 0 10rpx;
    }
    
    .candidate-item {
      position: relative;
      margin: 0 12rpx;
      
      &.selected {
        .candidate-avatar {
          border: 4rpx solid #81B64C;
        }
      }
      
      .candidate-avatar {
        width: 120rpx;
        height: 120rpx;
        border-radius: 16rpx;
      }
      
      .lock-icon {
        position: absolute;
        top: 5rpx;
        right: 5rpx;
        width: 32rpx;
        height: 32rpx;
      }
    }
  }
}

.action-button {
  width: 80%;
  height: 100rpx;
  background-color: #81B64C;
  border-radius: 50rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  align-self: center;
  margin-top: auto;
  margin-bottom: 20rpx;
  
  .button-text {
    color: #ffffff;
    font-size: 36rpx;
    font-weight: bold;
  }
}

.battle-section {
  flex: 1;
  padding: 30rpx;
  background-color: rgba(0, 0, 0, 0.3);
  border-radius: 20rpx;
  margin-bottom: 100rpx;
  display: flex;
  flex-direction: column;
}

.robot-chat-container {
  display: flex;
  margin-bottom: 30rpx;
  align-items: flex-start;
  min-height: 100rpx;
  
  .robot-chat-avatar {
    width: 80rpx;
    height: 80rpx;
    border-radius: 40rpx;
    margin-right: 20rpx;
  }
  
  .speech-bubble {
    background-color: #FFFFFF;
    border-radius: 20rpx;
    padding: 20rpx;
    position: relative;
    max-width: 70%;
    
    &:before {
      content: '';
      position: absolute;
      left: -12rpx;
      top: 30rpx;
      width: 0;
      height: 0;
      border-top: 12rpx solid transparent;
      border-right: 20rpx solid #FFFFFF;
      border-bottom: 12rpx solid transparent;
    }
    
    text {
      font-size: 28rpx;
      color: #333;
    }
  }
}

.match-info {
  flex: 1;
  background-color: rgba(255, 255, 255, 0.1);
  border-radius: 10rpx;
  margin-bottom: 20rpx;
  padding: 20rpx;
  
  .opening-info {
    display: flex;
    align-items: center;
    margin-bottom: 20rpx;
    
    .opening-text {
      font-size: 28rpx;
      color: #EEE;
      font-weight: bold;
    }
    
    .info-icon {
      margin-left: 10rpx;
    }
  }
  
  .moves-record {
    .moves-scroll {
      height: 300rpx;
    }
    
    .no-moves {
      padding: 20rpx;
      text-align: center;
      color: #CCC;
      font-style: italic;
    }
    
    .move-item {
      display: flex;
      margin-bottom: 15rpx;
      
      .move-number {
        width: 60rpx;
        color: #CCC;
        font-size: 24rpx;
        line-height: 50rpx;
      }
      
      .move-detail {
        flex: 1;
        display: flex;
      }
      
      .move-column {
        flex: 1;
        
        &.white-move {
          margin-right: 10rpx;
        }
        
        .move-notation {
          display: flex;
          align-items: center;
          background-color: rgba(255, 255, 255, 0.1);
          padding: 10rpx;
          border-radius: 8rpx;
          
          .piece-icon {
            width: 30rpx;
            height: 30rpx;
            margin-right: 10rpx;
          }
          
          text {
            color: #EEE;
            font-size: 24rpx;
          }
        }
      }
    }
  }
}

.control-buttons {
  display: flex;
  flex-direction: column;
  gap: 20rpx;
  margin-top: 20rpx;
  
  .ctrl-row {
    display: flex;
    justify-content: space-between;
    gap: 15rpx;
  }
  
  .ctrl-btn {
    flex: 1;
    height: 80rpx;
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 10rpx;
    display: flex;
    align-items: center;
    justify-content: center;
    
    text {
      color: #EEE;
      font-size: 28rpx;
    }
    
    .btn-icon {
      font-size: 32rpx;
    }
    
    &.hint-btn {
      background-color: #81B64C;
    }
    
    &.resign-btn {
      background-color: #e74c3c;
    }
    
    &.restart-btn, &.back-btn {
      height: 100rpx;
    }
  }
}

.promotion-dialog {
  width: 500rpx;
  background-color: rgba(0, 0, 0, 0.85);
  border-radius: 20rpx;
  padding: 30rpx;
  
  .promotion-title {
    color: #fff;
    font-size: 32rpx;
    text-align: center;
    margin-bottom: 30rpx;
  }
  
  .promotion-options {
    display: flex;
    justify-content: space-around;
    
    .promotion-option {
      width: 100rpx;
      height: 100rpx;
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 10rpx;
      display: flex;
      align-items: center;
      justify-content: center;
      
      image {
        width: 80rpx;
        height: 80rpx;
      }
      
      &:active {
        background-color: rgba(255, 255, 255, 0.4);
      }
    }
  }
}

.result-popup {
  width: 600rpx;
  padding: 40rpx;
  border-radius: 20rpx;
  text-align: center;
  background-color: rgba(30, 30, 30, 0.95);
  
  &.victory-popup {
    border: 4rpx solid #81B64C;
  }
  
  &.defeat-popup {
    border: 4rpx solid #e74c3c;
  }
  
  &.draw-popup {
    border: 4rpx solid #3498db;
  }
  
  .result-title {
    display: flex;
    flex-direction: column;
    font-size: 36rpx;
    color: #fff;
    margin-bottom: 40rpx;
    font-weight: bold;
    line-height: 1.5;
  }
  
  .result-players {
    display: flex;
    justify-content: space-around;
    align-items: center;
    margin-bottom: 40rpx;
    
    .player-side {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      
      &.winner-side {
        .player-avatar {
          border: 4rpx solid #81B64C;
        }
      }
      
      .player-avatar {
        width: 140rpx;
        height: 140rpx;
        border-radius: 10rpx;
        margin-bottom: 10rpx;
      }
      
      .player-name {
        font-size: 28rpx;
        color: #fff;
        margin-top: 10rpx;
      }
      
      .winner-mark {
        position: absolute;
        bottom: 40rpx;
        right: -10rpx;
        width: 40rpx;
        height: 40rpx;
        background-color: #81B64C;
        border-radius: 50%;
        
        &:before {
          content: '‚úì';
          color: #fff;
          font-size: 24rpx;
        }
      }
    }
    
    .vs-text {
      font-size: 32rpx;
      color: rgba(255, 255, 255, 0.7);
      font-weight: bold;
    }
  }
  
  .result-rating {
    display: flex;
    justify-content: center;
    margin-bottom: 40rpx;
    
    .crown {
      width: 60rpx;
      height: 60rpx;
      margin: 0 10rpx;
      background-image: url('https://pic1.imgdb.cn/item/67f3c5ffe381c3632bee9010.png');
      background-size: contain;
      background-repeat: no-repeat;
    }
  }
  
  .result-actions {
    display: flex;
    flex-direction: column;
    gap: 20rpx;
    
    .action-btn {
      padding: 25rpx 0;
      border-radius: 50rpx;
      font-size: 30rpx;
      font-weight: bold;
      
      &.primary-btn {
        background-color: #81B64C;
        color: #fff;
      }
      
      &.secondary-btn {
        background-color: rgba(255, 255, 255, 0.2);
        color: #fff;
      }
    }
  }
}
</style> 